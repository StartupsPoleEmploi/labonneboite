# this part should be common and maintained in another repo
include:
  - project: lbb/devops-jobs
    file: devops.gitlab-ci.yml

# this should be the local file
python-tests:
  extends: .devops::python-test
  after_script:
    # fix for coverage test not read by sonar
    - sed -i 's/\/labonneboite/\.\/labonneboite/g' testResults/coverage.xml
  rules:
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TITLE !~ /Draft.*/
      changes:
        - labonneboite/**/*
        - pyproject.toml
    - if: ( $CI_COMMIT_BRANCH == "main" &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - labonneboite/**/*
        - pyproject.toml

sonarqube:
  extends: .devops::sonarqube
  needs:
    - job: python-tests
  rules:
    - if: ( $CI_COMMIT_BRANCH == "main"  &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - labonneboite/**/*
        - pyproject.toml

pypi-publish:
  extends: .devops::pypi-publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+(\+.*)?$/

.devops::docker-publish:
  stage: publish
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"},\"$CI_DEPENDENCY_PROXY_SERVER\":{\"auth\":\"$(printf "%s:%s" ${CI_DEPENDENCY_PROXY_USER} "${CI_DEPENDENCY_PROXY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/docker/v3.10/Dockerfile"
      --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"

docker-publish:
  extends: .devops::docker-publish
  rules:
    - if: ( $CI_COMMIT_TAG && $CI_COMMIT_BRANCH == "test/dockerhub" )
