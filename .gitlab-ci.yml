# this part should be common and maintained in another repo
include:
  - project: lbb/devops-jobs
    file: devops.gitlab-ci.yml

# this should be the local file
python-tests:
  extends: .devops::python-test
  script:
    - set -ex
    - docker pull hello-world
    - docker-compose -f ./docker-compose.testing.yml up --abort-on-container-exit --exit-code-from $SERVICE_NAME
    - docker-compose -f docker-compose.testing.yml logs

  after_script:
    - ls
    - docker-compose -f docker-compose.testing.yml logs
  rules:
    - if: $CI_MERGE_REQUEST_IID && $CI_MERGE_REQUEST_TITLE !~ /Draft.*/
      changes:
        - labonneboite/**/*
        - pyproject.toml
    - if: ( $CI_COMMIT_BRANCH == "main" &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - labonneboite/**/*
        - pyproject.toml

sonarqube:
  extends: .devops::sonarqube
  needs:
    - job: python-tests
  rules:
    - if: ( $CI_COMMIT_BRANCH == "main"  &&   $CI_PIPELINE_SOURCE != 'schedule' )
      changes:
        - labonneboite/**/*
        - pyproject.toml

pypi-publish:
  extends: .devops::pypi-publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^\d+\.\d+\.\d+(\+.*)?$/
